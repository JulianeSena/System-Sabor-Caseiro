<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="/HTML front/CSS/style3.css" />
    <title>Pesquisa de Cliente</title>
</head>
<body>
    <div class="blur">

        <div class="cabecalho">
            <div class="esquerda">
                <img src="/HTML front/Image/chef.png" class="logo"/>
                <h2>Sabor<br>Caseiro</h2>
            </div>

            <div class="direita">
                <div class="user-info">
                    <h3>Bem Vindo!<br>Caixa</h3>
                    <button class="botao-logoff" id="btn-sair">Sair</button>
                </div>
                <img src="/HTML front/Image/avatar.png" class="avatar"/>
            </div>
        </div>

        <div class="corpo">
            <div id="promocao-banner" class="promocao-banner" style="display: none;">
                <h3 id="promocao-titulo"></h3>
                <p id="promocao-descricao"></p>
            </div>

            <h2>Pesquisa de Cliente</h2>

            <div class="pesquisa">
                <div class="campo-horizontal">
                    <label for="cpf">CPF:</label>
                    <input type="text" id="cpf" placeholder="Digite o CPF do cliente" class="input-pesquisa"/>
                </div>
            </div>

            <div class="botoes">
                <button class="botao-cinza" id="btn-pesquisar">Pesquisar</button>
                <button class="botao-cinza" id="btn-cadastrar">Cadastrar</button>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const API_URL = 'http://127.0.0.1:5000';
            const token = localStorage.getItem('acess_token');

            // Verifica se o usuário está logado (possui token)
            if (!token) {
                alert('Sessão expirada. Por favor, faça o login novamente.');
                window.location.href = 'caixa_login.html'; // Ou a página de login correta
            }

            // Função para buscar e exibir a promoção ativa
            async function carregarPromocaoAtiva() {
                try {
                    const response = await fetch(`${API_URL}/promocoes/ativas`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (!response.ok) return; // Falha silenciosamente se não conseguir buscar

                    const data = await response.json();
                    const promocaoAtiva = data.promocoes_ativas && data.promocoes_ativas[0]; // Pega a primeira promoção ativa, se existir

                    if (promocaoAtiva) {
                        document.getElementById('promocao-titulo').textContent = `PROMOÇÃO ATIVA: ${promocaoAtiva.titulo}`;
                        document.getElementById('promocao-descricao').textContent = promocaoAtiva.descricao;
                        document.getElementById('promocao-banner').style.display = 'block';
                    }

                } catch (error) {
                    console.error('Erro ao carregar promoção:', error);
                }
            }


            // Botão Sair (Logout)
            document.getElementById('btn-sair').addEventListener('click', () => {
                localStorage.removeItem('acess_token');
                alert('Você foi desconectado.');
                window.location.href = 'caixa_login.html'; // Redireciona para o login
            });

            // Botão Cadastrar
            document.getElementById('btn-cadastrar').addEventListener('click', () => {
                window.location.href = 'caix-cadastro.html';
            });

            // Botão Pesquisar
            document.getElementById('btn-pesquisar').addEventListener('click', async () => {
                const cpfInput = document.getElementById('cpf').value;
                const documento = cpfInput.replace(/\D/g, ''); // Remove caracteres não numéricos

                if (!documento) {
                    alert('Por favor, digite um CPF para pesquisar.');
                    return;
                }

                try {
                    const response = await fetch(`${API_URL}/cliente/busca`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ documento: documento })
                    });

                    const result = await response.json();

                    if (response.ok) {
                        // Se encontrou, redireciona para a página de detalhes do cliente
                        window.location.href = `caix-pesquisa.html?id=${result.cliente_id}`;
                    } else {
                        alert(result.message || 'Cliente não encontrado.');
                    }
                } catch (error) {
                    console.error('Erro ao pesquisar cliente:', error);
                    alert('Ocorreu um erro de comunicação com o servidor.');
                }
            });

            // Carrega a promoção ativa ao iniciar a página
            carregarPromocaoAtiva();
        });
    </script>
</body>
</html>
