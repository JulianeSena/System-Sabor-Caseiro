<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Gerente - Sabor Caseiro</title>
  <link rel="stylesheet" href="/HTML front/CSS/style2.css">
</head>
<body>

  <div class="blur">
    <header class="cabecalho">
      <div class="esquerda">
        <img src="/HTML front/Image/chef.png" alt="Logo" class="logo">
        <h2>Sabor<br>Caseiro</h2>
      </div>
      <div class="direita">
          <div class="user-info">
              <h3 id="welcome-message">Bem Vindo!<br>Gerente</h3>
              <button class="botao-logoff" id="btn-sair">Sair</button>
          </div>
          <img src="/HTML front/Image/avatar.png" class="avatar"/>
      </div>
    </header>

    <div class="corpo">
      <h2>Dashboard</h2>
      <p class="sub">VISÃO GERAL SABOR CASEIRO:</p>

      <div class="cards">

        <div class="gerent">
          <div class="card-content">
            <p class="card-title">Receita Total</p>
            <p class="card-value" id="receita-total">R$ 0,00</p>
          </div>
        </div>

        <div class="gerent">
          <div class="card-content">
            <p class="card-title">Cupons Emitidos</p>
            <p class="card-value" id="cupons-emitidos">0</p>
          </div>
        </div>

        <div class="gerent">
          <div class="card-content">
            <p class="card-title">Total de Clientes</p>
            <p class="card-value" id="total-clientes">0</p>
          </div>
        </div>
      </div>

      <div class="promocoes-container">
        <h3>Gerenciar Promoções</h3>
        <button class="promo" id="btn-criar-promocao">Criar Nova Promoção</button>
        <div id="lista-promocoes">

        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const API_URL = 'http://127.0.0.1:5000';
      const token = localStorage.getItem('acess_token');

      if (!token) {
        alert('Acesso não autorizado. Faça o login como gerente.');
        window.location.href = 'gerente_login.html';
        return;
      }

      const headers = {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      };

      // Carregar dados do Dashboard
      async function fetchDashboardData() {
        try {
          const response = await fetch(`${API_URL}/relatorios/dashboard`, { headers });
          if (!response.ok) throw new Error('Falha ao carregar dados do dashboard.');
          const data = await response.json();
          
          document.getElementById('receita-total').textContent = `R$ ${data.sumario.receita_total.toFixed(2)}`;
          document.getElementById('cupons-emitidos').textContent = data.sumario.total_cupons_emitidos;
          document.getElementById('total-clientes').textContent = data.sumario.total_clientes;
        } catch (error) {
          console.error('Erro no dashboard:', error);
          alert(error.message);
        }
      }

      // Carregar e exibir promoções
      async function fetchAndDisplayPromotions() {
        try {
          const response = await fetch(`${API_URL}/promocoes`, { headers });
          if (!response.ok) throw new Error('Falha ao carregar promoções.');
          
          const { promocoes } = await response.json();
          const listaPromocoesDiv = document.getElementById('lista-promocoes');
          listaPromocoesDiv.innerHTML = ''; // Limpa a lista antes de preencher

          if (promocoes.length === 0) {
            listaPromocoesDiv.innerHTML = '<p class="sem-promocoes">Nenhuma promoção cadastrada.</p>';
            return;
          }

          promocoes.forEach(promocao => {
            const itemDiv = document.createElement('div');
            // Adiciona uma classe se a promoção estiver ativa para estilização
            itemDiv.className = `promocao-item ${promocao.is_ativa ? 'ativa' : ''}`;

            const isActive = promocao.is_ativa;
            const toggleButtonText = isActive ? 'Desativar' : 'Ativar';
            const toggleButtonClass = isActive ? 'btn-toggle-active active' : 'btn-toggle-active';

            itemDiv.innerHTML = `
              <div class="promocao-info">
                <strong>${promocao.titulo} ${isActive ? '<span class="status-ativa">(Ativa)</span>' : ''}</strong>
                <p>${promocao.descricao}</p>
              </div>
              <div class="promocao-actions">
                <button class="${toggleButtonClass}" data-id="${promocao.promocao_id}" data-active="${isActive}">${toggleButtonText}</button>
                <button class="btn-delete" data-id="${promocao.promocao_id}">Deletar</button>
              </div>
            `;

            // Adiciona evento de clique para o botão ATIVAR/DESATIVAR
            itemDiv.querySelector('.btn-toggle-active').addEventListener('click', async (e) => {
              const id = e.target.dataset.id;
              const currentStatus = e.target.dataset.active === 'true';
              
              const updateResponse = await fetch(`${API_URL}/promocoes/${id}`, {
                  method: 'PUT',
                  headers,
                  body: JSON.stringify({ is_ativa: !currentStatus })
              });

              if (updateResponse.ok) {
                  fetchAndDisplayPromotions(); // Atualiza a lista para refletir a mudança
              } else {
                  alert('Falha ao atualizar o status da promoção.');
              }
            });

            // Adiciona evento de clique para o botão deletar
            itemDiv.querySelector('.btn-delete').addEventListener('click', async (e) => {
              const id = e.target.dataset.id;
              if (confirm('Tem certeza que deseja deletar esta promoção?')) {
                const deleteResponse = await fetch(`${API_URL}/promocoes/${id}`, { method: 'DELETE', headers });
                const result = await deleteResponse.json();
                alert(result.message);
                if (deleteResponse.ok) {
                  fetchAndDisplayPromotions(); // Atualiza a lista
                }
              }
            });

            listaPromocoesDiv.appendChild(itemDiv);
          });
        } catch (error) {
          console.error('Erro ao buscar promoções:', error);
          document.getElementById('lista-promocoes').innerHTML = '<p class="sem-promocoes">Erro ao carregar promoções.</p>';
        }
      }

      // Criar nova promoção
      document.getElementById('btn-criar-promocao').addEventListener('click', async () => {
        const titulo = prompt("Digite o título da nova promoção:");
        const descricao = prompt("Digite a descrição da promoção:");

        if (titulo && descricao) {
          try {
            const response = await fetch(`${API_URL}/promocoes`, {
              method: 'POST',
              headers,
              body: JSON.stringify({ titulo, descricao })
            });
            const result = await response.json();
            alert(response.ok ? 'Promoção criada com sucesso!' : `Erro: ${result.message}`);
            if (response.ok) fetchAndDisplayPromotions(); // Atualiza a lista
          } catch (error) {
            alert('Erro ao criar promoção.');
          }
        }
      });

      // Logout
      document.getElementById('btn-sair').addEventListener('click', () => {
        localStorage.removeItem('acess_token');
        window.location.href = 'gerente_login.html';
      });

      fetchDashboardData();
      fetchAndDisplayPromotions(); // Chamada inicial para listar as promoções
    });
  </script>
</body>
</html>