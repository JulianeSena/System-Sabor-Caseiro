<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="/HTML front/CSS/style2.css" />
    <title>Sabor Caseiro</title>
</head>
<body>
    <div class="blur">

        <div class="cabecalho">
            <div class="esquerda">
                <img src="/HTML front/Image/chef.png" class="logo"/>
                <h2>Sabor<br>Caseiro</h2>
            </div>

            <div class="direita">
                <div class="user-info">
                    <h3 id="welcome-message">Bem Vindo!</h3>
                    <button class="botao-logoff" id="btn-sair">Sair</button>
                </div>
                <img src="/HTML front/Image/avatar.png" class="avatar"/>
            </div>
        </div>

        <div class="corpo">
            <div id="promocao-banner" class="promocao-banner" style="display: none;">
                <h3 id="promocao-titulo"></h3>
                <p id="promocao-descricao"></p>
            </div>    

            <h2>Confira seu cartão fidelidade!</h2>
            
            <table id="tabela-cupons">
            
            </table>

            <div class="result">
                <h2 class="texto" id="texto-desconto">Carregando...</h2>
            </div>

            <div class="canais">
                <h4 class="end">
                    Confira nossos endereços:<br>
                    Av. Presidente Vargas N° 799<br>
                    Av. Tupy Silveira N° 1890<br>
                </h4>
                <h4 class="tel">
                    Números de contato:<br>
                    (53) 99999-1431<br>
                    (53) 99934-5676<br>
                </h4>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const API_URL = 'http://127.0.0.1:5000';
            const token = localStorage.getItem('acess_token');

            
            if (!token) {
                alert('Sessão não iniciada. Por favor, faça o login.');
                window.location.href = 'cliente_login.html';
                return;
            }
                
           
            function getClientIdFromToken(token) {
                try {
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    return payload.sub;  
                } catch (e) {
                    console.error('Erro ao decodificar token:', e);
                    return null;
                }
            }

            
            async function carregarPromocaoAtiva() {
                try {
                    const response = await fetch(`${API_URL}/promocoes/ativas`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (!response.ok) return;  

                    const data = await response.json();
                    const promocaoAtiva = data.promocoes_ativas && data.promocoes_ativas[0];

                    if (promocaoAtiva) {
                        document.getElementById('promocao-titulo').textContent = `PROMOÇÃO ATIVA: ${promocaoAtiva.titulo}`;
                        document.getElementById('promocao-descricao').textContent = promocaoAtiva.descricao;
                        document.getElementById('promocao-banner').style.display = 'block';
                    }

                } catch (error) {
                    console.error('Erro ao carregar promoção:', error);
                }
            }

            const clienteId = getClientIdFromToken(token);

            if (!clienteId) {
                alert('Token inválido. Faça o login novamente.');
                localStorage.removeItem('acess_token');
                window.location.href = 'cliente_login.html';
                return;
            }

            
            try {
                
                carregarPromocaoAtiva();

                
                const resCliente = await fetch(`${API_URL}/cliente/${clienteId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!resCliente.ok) throw new Error('Falha ao buscar dados do cliente.');
                const cliente = await resCliente.json();
                document.getElementById('welcome-message').innerHTML = `Bem Vindo!<br>${cliente.nome}`;

                
                const resCupons = await fetch(`${API_URL}/cliente/${clienteId}/cupons`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!resCupons.ok) throw new Error('Falha ao buscar cupons.');
                const { cupons } = await resCupons.json();

                
                const tabelaCupons = document.getElementById('tabela-cupons');
                tabelaCupons.innerHTML = '';  
                let linha;
                cupons.forEach((cupom, index) => {
                    if (index % 4 === 0) {  
                        linha = tabelaCupons.insertRow();
                    }
                    const celula = linha.insertCell();
                    celula.textContent = `R$ ${parseFloat(cupom.preco_cupom).toFixed(2)}`;
                });

                 
                const textoDesconto = document.getElementById('texto-desconto');
                const numCiclosCompletos = Math.floor(cupons.length / 10);
                const cuponsNoCicloAtual = cupons.length % 10;

                if (cuponsNoCicloAtual === 0 && cupons.length > 0) {
                     
                    const ultimos10cupons = cupons.slice(-10);
                    const soma = ultimos10cupons.reduce((acc, cupom) => acc + cupom.preco_cupom, 0);
                    const media = soma / 10;
                    textoDesconto.innerHTML = `Cupom de Desconto Disponível: <span class="valor-desconto">R$ ${media.toFixed(2)}</span>`;
                } else {
                    textoDesconto.textContent = `Faltam ${10 - cuponsNoCicloAtual} refeições para seu próximo cupom!`;
                }

            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                alert('Ocorreu um erro ao carregar seus dados. Tente novamente.');
            }

            
            document.getElementById('btn-sair').addEventListener('click', async () => {
                try {
                    await fetch(`${API_URL}/logout`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                } catch (e) {
                    console.error("Erro no logout, mas desconectando localmente:", e);
                } finally {
                    localStorage.removeItem('acess_token');
                    alert('Você foi desconectado.');
                    window.location.href = 'cliente_login.html';
                }
            });

        });
    </script>
</body>
</html>
